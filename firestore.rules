rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function getUserRole() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) ?
             (let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
              'primaryRole' in userData ? userData.primaryRole.lower() :
              ('personalInfo' in userData && 'role' in userData.personalInfo ? 
               userData.personalInfo.role.lower() : '')) : '';
    }

    // Helper functions
    function isAdmin() {
      return request.auth != null && getUserRole() == 'admin';
    }

    function isFaculty() {
      return request.auth != null && getUserRole() == 'faculty';
    }

    function isParent() {
      return request.auth != null && getUserRole() == 'parent';
    }

    // Announcements: anyone can read, only admins can write
    match /announcements/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Report Card Drafts: teachers can read/write their own drafts
    match /reportCardDrafts/{draftId} {
      allow read, write: if isFaculty() && resource.data.uid == request.auth.uid;
      allow create: if isFaculty() && request.resource.data.uid == request.auth.uid;
    }

    // Report Cards: teachers can read/write their own completed reports
    match /reportCards/{reportId} {
      allow read, write: if isFaculty() && resource.data.uid == request.auth.uid;
      allow create: if isFaculty() && request.resource.data.uid == request.auth.uid;
    }

    // Admins can read and write all other data
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // Users collection
    match /users/{userId} {
      // Admins can read any user document; users can read their own; parents can read their children's profiles
      allow read: if isAdmin() ||
                    request.auth.uid == userId ||
                    (
                      isParent() &&
                      exists(/databases/$(database)/documents/students/$(userId)) &&
                      'parents' in get(/databases/$(database)/documents/students/$(userId)).data &&
                      (
                        ('father' in get(/databases/$(database)/documents/students/$(userId)).data.parents &&
                         get(/databases/$(database)/documents/students/$(userId)).data.parents.father.tarbiyahid == request.auth.uid) ||
                        ('mother' in get(/databases/$(database)/documents/students/$(userId)).data.parents &&
                         get(/databases/$(database)/documents/students/$(userId)).data.parents.mother.tarbiyahid == request.auth.uid)
                      )
                    );
      // Admins can create/update/delete any user document; users can write their own
      allow create, update, delete: if isAdmin() || request.auth.uid == userId;
    }

    // Rules for courses
    match /courses/{courseId} {
        allow read, update: if isFaculty() && (
          request.auth.uid in resource.data.teacherIds ||
          courseId in get(/databases/$(database)/documents/faculty/$(request.auth.uid)).data.courses
        );
        // Parents can read courses their children are enrolled in.
        allow read: if isParent() && exists(/databases/$(database)/documents/students/$(request.auth.uid)) &&
                     courseId in get(/databases/$(database)/documents/students/$(request.auth.uid)).data.enrolledCourses;
    }

    // Rules for students
    match /students/{studentId} {
        // Teachers can read student data IF that student is enrolled in a course the teacher manages.
        allow read: if isFaculty() &&
                       'teacherProfile' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data &&
                       'classesManaged' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherProfile &&
                       'enrolledCourses' in resource.data &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherProfile.classesManaged.toSet().intersection(resource.data.enrolledCourses.toSet()).size() > 0;

        // Parents can read and write their own children's data
        allow read, write: if isParent() &&
                           'parents' in resource.data &&
                           (
                             ('father' in resource.data.parents && resource.data.parents.father.tarbiyahid == request.auth.uid) ||
                             ('mother' in resource.data.parents && resource.data.parents.mother.tarbiyahid == request.auth.uid)
                           );
    }

    // Allow users to read their own faculty doc
    match /faculty/{facultyId} {
      allow read: if request.auth.uid == facultyId;
    }

    // Allow parents to read and write their own doc
    match /parents/{parentId} {
      allow read, write: if request.auth.uid == parentId;
    }

    // Allow admins to read and write all user collections
    match /students/{studentId} {
      allow read, write: if isAdmin();
    }

    match /faculty/{facultyId} {
      allow read, write: if isAdmin();
    }

    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }
  }
} 