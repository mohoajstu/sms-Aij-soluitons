rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAdmin() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return
        (
          userData.primaryRole != null &&
          (userData.primaryRole.lower() == 'admin' ||
           userData.primaryRole.lower() == 'schooladmin' ||
           userData.primaryRole.lower() == 'school_admin')
        ) ||
        (
          userData.role != null &&
          (userData.role.lower() == 'admin' ||
           userData.role.lower() == 'schooladmin' ||
           userData.role.lower() == 'school_admin')
        ) ||
        (
          userData.personalInfo != null &&
          (
            (userData.personalInfo.role != null &&
             (userData.personalInfo.role.lower() == 'admin' ||
              userData.personalInfo.role.lower() == 'schooladmin' ||
              userData.personalInfo.role.lower() == 'school_admin')) ||
            (userData.personalInfo.primaryRole != null &&
             (userData.personalInfo.primaryRole.lower() == 'admin' ||
              userData.personalInfo.primaryRole.lower() == 'schooladmin' ||
              userData.personalInfo.primaryRole.lower() == 'school_admin'))
          )
        );
    }

    function isFaculty() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return (userData.primaryRole != null && userData.primaryRole.lower() == 'faculty') ||
             (userData.role != null && userData.role.lower() == 'faculty') ||
             (userData.personalInfo != null && userData.personalInfo.role != null && userData.personalInfo.role.lower() == 'faculty') ||
             (userData.personalInfo != null && userData.personalInfo.primaryRole != null && userData.personalInfo.primaryRole.lower() == 'faculty');
    }

    function isParent() {
      let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      return (userData.primaryRole != null && userData.primaryRole.lower() == 'parent') ||
             (userData.role != null && userData.role.lower() == 'parent') ||
             (userData.personalInfo != null && userData.personalInfo.role != null && userData.personalInfo.role.lower() == 'parent') ||
             (userData.personalInfo != null && userData.personalInfo.primaryRole != null && userData.personalInfo.primaryRole.lower() == 'parent');
    }

    function isAuthenticated() {
      return request.auth != null;
    }

    // Registration forms: ANYONE can create (for public registration), admins/faculty can read/write
    match /registrations/{docId} {
      allow create: if true; // Allow anyone to submit registration forms
      allow read, write, update, delete: if isAdmin() || isFaculty();
    }

    // Counters collection: needed for generating registration IDs - allow authenticated access
    match /counters/{docId} {
      allow read, write: if isAuthenticated();
    }

    // Announcements: anyone can read, only admins can write
    match /announcements/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Report Card Drafts: teachers can read/write their own drafts, admins can read/write all
    match /reportCardDrafts/{draftId} {
      allow read, write: if isAdmin();
      allow read, write: if isFaculty() && resource.data.uid == request.auth.uid;
      allow create: if isFaculty() && request.resource.data.uid == request.auth.uid;
    }

    // Report Cards: teachers can read/write their own, admins can read/write all, parents can read approved ones
    match /reportCards/{reportId} {
      allow read, write: if isAdmin();
      allow read, write: if isFaculty() && resource.data.uid == request.auth.uid;
      allow create: if isFaculty() && request.resource.data.uid == request.auth.uid;
      // Parents can read approved/published report cards for their children
      allow read: if isParent() && 
                     resource.data.status in ['approved', 'published'] &&
                     'tarbiyahId' in resource.data;
    }

    // Users can read their own profile or if they're a parent (temporarily permissive)
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isParent();
      allow write: if request.auth.uid == userId || isParent() || isFaculty();
    }

    // Rules for courses
    match /courses/{courseId} {
        allow read, update: if isFaculty() && (
          request.auth.uid in resource.data.teacherIds ||
          courseId in get(/databases/$(database)/documents/faculty/$(request.auth.uid)).data.courses
        );
        // Parents can read courses their children are enrolled in.
        allow read: if isParent() && exists(/databases/$(database)/documents/students/$(request.auth.uid)) &&
                     courseId in get(/databases/$(database)/documents/students/$(request.auth.uid)).data.enrolledCourses;
    }

    // Rules for students - allow self access; keep current parent/faculty logic
    match /students/{studentId} {
      // Teachers can read student data IF that student is enrolled in a course the teacher manages.
      allow read: if isFaculty() &&
                     'teacherProfile' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data &&
                     'classesManaged' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherProfile &&
                     'enrolledCourses' in resource.data &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.teacherProfile.classesManaged.toSet().intersection(resource.data.enrolledCourses.toSet()).size() > 0
                  ||
                  // Any parent (temporarily permissive)
                  isParent()
                  ||
                  // Student can access their own doc (by uid or tarbiyahId stored on their users doc)
                  (
                    request.auth != null &&
                    (
                      studentId == request.auth.uid ||
                      studentId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tarbiyahId
                    )
                  );

      // TEMPORARILY PERMISSIVE: Allow any parent to write student data
      // Plus allow the student to write their own doc (for Profile page saves)
      allow write: if isParent() ||
                   (
                     request.auth != null &&
                     (
                       studentId == request.auth.uid ||
                       studentId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tarbiyahId
                     )
                   );
    }
    
    // Allow faculty to read and write their own faculty document
    match /faculty/{facultyId} {
      allow read, write: if request.auth.uid == facultyId;
    }
    
    // Allow faculty to read courses and students
    match /courses/{courseId} {
      allow read: if true;
    }
    
    match /students/{studentId} {
      allow read: if true;
    }
    
    // Allow users to read their own user document
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // Allow parents to read and write their own document
    match /parents/{parentId} {
      allow read, write: if request.auth.uid == parentId;
    }
    
    // Allow admins to read and write all documents
    match /admins/{adminId} {
      allow read, write: if true;
    }
    
    // Announcements: anyone can read, only admins can write
    match /announcements/{docId} {
      allow read: if true;
      allow write: if true;
    }
    
    // Default rule - allow all for now (we can tighten this later)
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
